/**
 * AJAX Upload
 * Project page - http://valums.com/ajax-upload/
 * Copyright (c) 2008 Andris Valums, http://valums.com
 * Licensed under the MIT license (http://valums.com/mit-license/)
 */(function(){function n(t){typeof t=="string"&&(t=e.getElementById(t));return t}function r(e,n,r){if(t.addEventListener)e.addEventListener(n,r,!1);else if(t.attachEvent){var i=function(){r.call(e,t.event)};e.attachEvent("on"+n,i)}}function s(e,t){return e.className.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))}function o(e,t){s(e,t)||(e.className+=" "+t)}function u(e,t){var n=new RegExp("(\\s|^)"+t+"(\\s|$)");e.className=e.className.replace(n," ")}function f(e){var t,n,r,i,s=a(e);t=s.left;r=s.top;n=t+e.offsetWidth;i=r+e.offsetHeight;return{left:t,right:n,top:r,bottom:i}}function l(t){if(!t.pageX&&t.clientX){var n=1,r=document.body;if(r.getBoundingClientRect){var i=r.getBoundingClientRect();n=(i.right-i.left)/r.clientWidth}return{x:t.clientX/n+e.body.scrollLeft+e.documentElement.scrollLeft,y:t.clientY/n+e.body.scrollTop+e.documentElement.scrollTop}}return{x:t.pageX,y:t.pageY}}function h(e){return e.replace(/.*(\/|\\)/,"")}function p(e){return/[.]/.exec(e)?/[^.]+$/.exec(e.toLowerCase()):""}var e=document,t=window,i=function(){var t=e.createElement("div");return function(e){t.innerHTML=e;var n=t.childNodes[0];t.removeChild(n);return n}}();if(document.documentElement.getBoundingClientRect)var a=function(e){var t=e.getBoundingClientRect(),n=e.ownerDocument,r=n.body,i=n.documentElement,s=i.clientTop||r.clientTop||0,o=i.clientLeft||r.clientLeft||0,u=1;if(r.getBoundingClientRect){var a=r.getBoundingClientRect();u=(a.right-a.left)/r.clientWidth}if(u>1){s=0;o=0}var f=t.top/u+(window.pageYOffset||i&&i.scrollTop/u||r.scrollTop/u)-s,l=t.left/u+(window.pageXOffset||i&&i.scrollLeft/u||r.scrollLeft/u)-o;return{top:f,left:l}};else var a=function(e){if(t.jQuery)return jQuery(e).offset();var n=0,r=0;do{n+=e.offsetTop||0;r+=e.offsetLeft||0}while(e=e.offsetParent);return{left:r,top:n}};var c=function(){var e=0;return function(){return"ValumsAjaxUpload"+e++}}(),d=function(){var e;return function(){if(e)return e;if(typeof XMLHttpRequest!="undefined")e=new XMLHttpRequest;else{var t=["Microsoft.XmlHttp","MSXML2.XmlHttp.5.0","MSXML2.XmlHttp.4.0","MSXML2.XmlHttp.3.0","MSXML2.XmlHttp.2.0"];for(var n=0;n<t.length;n++)try{e=new ActiveXObject(t[n]);break}catch(r){}}return e}}();Ajax_upload=AjaxUpload=function(t,r){t.jquery?t=t[0]:typeof t=="string"&&/^#.*/.test(t)&&(t=t.slice(1));t=n(t);this._input=null;this._button=t;this._disabled=!1;this._submitting=!1;this._justClicked=!1;this._parentDialog=e.body;if(window.jQuery&&jQuery.ui&&jQuery.ui.dialog){var i=jQuery(this._button).parents(".ui-dialog");i.length&&(this._parentDialog=i[0])}this._settings={action:"upload.php",name:"userfile",data:{},autoSubmit:!0,responseType:!1,closeConnection:"",hoverClass:"hover",onChange:function(e,t){},onSubmit:function(e,t){},onComplete:function(e,t){}};for(var s in r)this._settings[s]=r[s];this._createInput();this._rerouteClicks()};AjaxUpload.prototype={setData:function(e){this._settings.data=e},disable:function(){this._disabled=!0},enable:function(){this._disabled=!1},destroy:function(){if(this._input){this._input.parentNode&&this._input.parentNode.removeChild(this._input);this._input=null}},_createInput:function(){var t=this,n=e.createElement("input");n.setAttribute("type","file");n.setAttribute("name",this._settings.name);var i={position:"absolute",margin:"-5px 0 0 -175px",padding:0,width:"220px",height:"30px",fontSize:"14px",opacity:0,cursor:"pointer",display:"none",zIndex:2147483583};for(var s in i)n.style[s]=i[s];n.style.opacity!=="0"&&(n.style.filter="alpha(opacity=0)");this._parentDialog.appendChild(n);r(n,"change",function(){var e=h(this.value);if(t._settings.onChange.call(t,e,p(e))==0)return;t._settings.autoSubmit&&t.submit()});r(n,"click",function(){t.justClicked=!0;setTimeout(function(){t.justClicked=!1},2500)});this._input=n},_rerouteClicks:function(){var t=this,n,i={top:0,left:0},s=!1;r(t._button,"mouseover",function(r){if(!t._input||s)return;s=!0;n=f(t._button);t._parentDialog!=e.body&&(i=a(t._parentDialog))});r(document,"mousemove",function(e){var r=t._input;if(!r||!s)return;if(t._disabled){u(t._button,t._settings.hoverClass);r.style.display="none";return}var a=l(e);if(a.x>=n.left&&a.x<=n.right&&a.y>=n.top&&a.y<=n.bottom){r.style.top=a.y-i.top+"px";r.style.left=a.x-i.left+"px";r.style.display="block";o(t._button,t._settings.hoverClass)}else{s=!1;var f=setInterval(function(){if(t.justClicked)return;s||(r.style.display="none");clearInterval(f)},25);u(t._button,t._settings.hoverClass)}})},_createIframe:function(){var t=c(),n=i('<iframe src="javascript:false;" name="'+t+'" />');n.id=t;n.style.display="none";e.body.appendChild(n);return n},submit:function(){var t=this,n=this._settings;if(this._input.value==="")return;var i=h(this._input.value);if(n.onSubmit.call(this,i,p(i))!=0){var s=this._createIframe(),o=this._createForm(s);o.appendChild(this._input);if(n.closeConnection&&/AppleWebKit|MSIE/.test(navigator.userAgent)){var u=d();u.open("GET",n.closeConnection,!1);u.send("")}o.submit();e.body.removeChild(o);o=null;this._input=null;this._createInput();var a=!1;r(s,"load",function(r){if(s.src=="javascript:'%3Chtml%3E%3C/html%3E';"||s.src=="javascript:'<html></html>';"){a&&setTimeout(function(){e.body.removeChild(s)},0);return}var o=s.contentDocument?s.contentDocument:frames[s.id].document;if(o.readyState&&o.readyState!="complete")return;if(o.body&&o.body.innerHTML=="false")return;var u;if(o.XMLDocument)u=o.XMLDocument;else if(o.body){u=o.body.innerHTML;if(n.responseType&&n.responseType.toLowerCase()=="json"){o.body.firstChild&&o.body.firstChild.nodeName.toUpperCase()=="PRE"&&(u=o.body.firstChild.firstChild.nodeValue);u?u=window.eval("( "+u+")"):u={}}}else var u=o;n.onComplete.call(t,i,u);a=!0;s.src="javascript:'<html></html>';"})}else{e.body.removeChild(this._input);this._input=null;this._createInput()}},_createForm:function(t){var n=this._settings,r=i('<form method="post" enctype="multipart/form-data"></form>');r.style.display="none";r.action=n.action;r.target=t.name;e.body.appendChild(r);for(var s in n.data){var o=e.createElement("input");o.type="hidden";o.name=s;o.value=n.data[s];r.appendChild(o)}return r}}})();